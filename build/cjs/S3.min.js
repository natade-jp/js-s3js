"use strict";const t={EPSILON:2.220446049250313e-8,clamp:function(t,e,s){return t<e?e:t>s?s:t},step:function(t,e){return t>e?1:0},mix:function(t,e,s){return t+(e-t)*s},smoothstep:function(t,e,s){return t+(e-t)*(s*s*(3-2*s))},equals:function(e,s){return Math.abs(e-s)<t.EPSILON},mod:function(t,e){return t-e*Math.floor(t/e)},sign:function(t){return t>=0?1:-1},fract:function(t){return t-Math.floor(t)},rsqrt:function(t){return Math.sqrt(1/t)},radius:function(t){return t/360*(2*Math.PI)},degrees:function(t){return t/(2*Math.PI)*360}};class e{constructor(t,e,s,i,n,r,o,a,h,m,l,c,u,d,g,f){if(0===arguments.length)this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m20=0,this.m21=0,this.m22=0,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=0;else if(9===arguments.length)this.m00=t,this.m01=e,this.m02=s,this.m03=0,this.m10=i,this.m11=n,this.m12=r,this.m13=0,this.m20=o,this.m21=a,this.m22=h,this.m23=0,this.m30=0,this.m31=0,this.m32=0,this.m33=1;else{if(16!==arguments.length)throw"IllegalArgumentException";this.m00=t,this.m01=e,this.m02=s,this.m03=i,this.m10=n,this.m11=r,this.m12=o,this.m13=a,this.m20=h,this.m21=m,this.m22=l,this.m23=c,this.m30=u,this.m31=d,this.m32=g,this.m33=f}}equals(e){return t.equals(this.m00,e.m00)&&t.equals(this.m01,e.m01)&&t.equals(this.m02,e.m02)&&t.equals(this.m03,e.m03)&&t.equals(this.m10,e.m10)&&t.equals(this.m11,e.m11)&&t.equals(this.m12,e.m12)&&t.equals(this.m13,e.m13)&&t.equals(this.m20,e.m20)&&t.equals(this.m21,e.m21)&&t.equals(this.m22,e.m22)&&t.equals(this.m23,e.m23)&&t.equals(this.m30,e.m30)&&t.equals(this.m31,e.m31)&&t.equals(this.m32,e.m32)&&t.equals(this.m33,e.m33)}clone(){return new e(this.m00,this.m01,this.m02,this.m03,this.m10,this.m11,this.m12,this.m13,this.m20,this.m21,this.m22,this.m23,this.m30,this.m31,this.m32,this.m33)}transposed(){return new e(this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33)}isNaN(){return isNaN(this.m00)||isNaN(this.m01)||isNaN(this.m02)||isNaN(this.m03)||isNaN(this.m10)||isNaN(this.m11)||isNaN(this.m12)||isNaN(this.m13)||isNaN(this.m20)||isNaN(this.m21)||isNaN(this.m22)||isNaN(this.m23)||isNaN(this.m30)||isNaN(this.m31)||isNaN(this.m32)||isNaN(this.m33)}isFinite(){return isFinite(this.m00)&&isFinite(this.m01)&&isFinite(this.m02)&&isFinite(this.m03)||isFinite(this.m10)&&isFinite(this.m11)&&isFinite(this.m12)&&isFinite(this.m13)||isFinite(this.m20)&&isFinite(this.m21)&&isFinite(this.m22)&&isFinite(this.m23)||isFinite(this.m30)&&isFinite(this.m31)&&isFinite(this.m32)&&isFinite(this.m33)}isRealNumber(){return!this.isNaN()&&this.isFinite()}mulMatrix(t){const s=this,i=t,n=new e;return n.m00=s.m00*i.m00+s.m01*i.m10+s.m02*i.m20+s.m03*i.m30,n.m01=s.m00*i.m01+s.m01*i.m11+s.m02*i.m21+s.m03*i.m31,n.m02=s.m00*i.m02+s.m01*i.m12+s.m02*i.m22+s.m03*i.m32,n.m03=s.m00*i.m03+s.m01*i.m13+s.m02*i.m23+s.m03*i.m33,n.m10=s.m10*i.m00+s.m11*i.m10+s.m12*i.m20+s.m13*i.m30,n.m11=s.m10*i.m01+s.m11*i.m11+s.m12*i.m21+s.m13*i.m31,n.m12=s.m10*i.m02+s.m11*i.m12+s.m12*i.m22+s.m13*i.m32,n.m13=s.m10*i.m03+s.m11*i.m13+s.m12*i.m23+s.m13*i.m33,n.m20=s.m20*i.m00+s.m21*i.m10+s.m22*i.m20+s.m23*i.m30,n.m21=s.m20*i.m01+s.m21*i.m11+s.m22*i.m21+s.m23*i.m31,n.m22=s.m20*i.m02+s.m21*i.m12+s.m22*i.m22+s.m23*i.m32,n.m23=s.m20*i.m03+s.m21*i.m13+s.m22*i.m23+s.m23*i.m33,n.m30=s.m30*i.m00+s.m31*i.m10+s.m32*i.m20+s.m33*i.m30,n.m31=s.m30*i.m01+s.m31*i.m11+s.m32*i.m21+s.m33*i.m31,n.m32=s.m30*i.m02+s.m31*i.m12+s.m32*i.m22+s.m33*i.m32,n.m33=s.m30*i.m03+s.m31*i.m13+s.m32*i.m23+s.m33*i.m33,n}mulVector(t){const e=this,i=t;return new s(e.m00*i.x+e.m01*i.y+e.m02*i.z+e.m03*i.w,e.m10*i.x+e.m11*i.y+e.m12*i.z+e.m13*i.w,e.m20*i.x+e.m21*i.y+e.m22*i.z+e.m23*i.w,e.m30*i.x+e.m31*i.y+e.m32*i.z+e.m33*i.w)}det3(){const t=this;let e;return e=t.m00*t.m11*t.m22,e+=t.m10*t.m21*t.m02,e+=t.m20*t.m01*t.m12,e-=t.m00*t.m21*t.m12,e-=t.m20*t.m11*t.m02,e-=t.m10*t.m01*t.m22,e}inverse3(){const t=this,e=t.det3();if(0===e)return null;const s=1/e,i=t.clone();return i.m00=(t.m11*t.m22-t.m12*t.m21)*s,i.m01=(t.m02*t.m21-t.m01*t.m22)*s,i.m02=(t.m01*t.m12-t.m02*t.m11)*s,i.m10=(t.m12*t.m20-t.m10*t.m22)*s,i.m11=(t.m00*t.m22-t.m02*t.m20)*s,i.m12=(t.m02*t.m10-t.m00*t.m12)*s,i.m20=(t.m10*t.m21-t.m11*t.m20)*s,i.m21=(t.m01*t.m20-t.m00*t.m21)*s,i.m22=(t.m00*t.m11-t.m01*t.m10)*s,i}det4(){const t=this;let e;return e=t.m00*t.m11*t.m22*t.m33,e+=t.m00*t.m12*t.m23*t.m31,e+=t.m00*t.m13*t.m21*t.m32,e+=t.m01*t.m10*t.m23*t.m32,e+=t.m01*t.m12*t.m20*t.m33,e+=t.m01*t.m13*t.m22*t.m30,e+=t.m02*t.m10*t.m21*t.m33,e+=t.m02*t.m11*t.m23*t.m30,e+=t.m02*t.m13*t.m20*t.m31,e+=t.m03*t.m10*t.m22*t.m31,e+=t.m03*t.m11*t.m20*t.m32,e+=t.m03*t.m12*t.m21*t.m30,e-=t.m00*t.m11*t.m23*t.m32,e-=t.m00*t.m12*t.m21*t.m33,e-=t.m00*t.m13*t.m22*t.m31,e-=t.m01*t.m10*t.m22*t.m33,e-=t.m01*t.m12*t.m23*t.m30,e-=t.m01*t.m13*t.m20*t.m32,e-=t.m02*t.m10*t.m23*t.m31,e-=t.m02*t.m11*t.m20*t.m33,e-=t.m02*t.m13*t.m21*t.m30,e-=t.m03*t.m10*t.m21*t.m32,e-=t.m03*t.m11*t.m22*t.m30,e-=t.m03*t.m12*t.m20*t.m31,e}inverse4(){const t=this,s=t.det4();if(0===s)return null;const i=1/s,n=new e;return n.m00=(t.m11*t.m22*t.m33+t.m12*t.m23*t.m31+t.m13*t.m21*t.m32-t.m11*t.m23*t.m32-t.m12*t.m21*t.m33-t.m13*t.m22*t.m31)*i,n.m01=(t.m01*t.m23*t.m32+t.m02*t.m21*t.m33+t.m03*t.m22*t.m31-t.m01*t.m22*t.m33-t.m02*t.m23*t.m31-t.m03*t.m21*t.m32)*i,n.m02=(t.m01*t.m12*t.m33+t.m02*t.m13*t.m31+t.m03*t.m11*t.m32-t.m01*t.m13*t.m32-t.m02*t.m11*t.m33-t.m03*t.m12*t.m31)*i,n.m03=(t.m01*t.m13*t.m22+t.m02*t.m11*t.m23+t.m03*t.m12*t.m21-t.m01*t.m12*t.m23-t.m02*t.m13*t.m21-t.m03*t.m11*t.m22)*i,n.m10=(t.m10*t.m23*t.m32+t.m12*t.m20*t.m33+t.m13*t.m22*t.m30-t.m10*t.m22*t.m33-t.m12*t.m23*t.m30-t.m13*t.m20*t.m32)*i,n.m11=(t.m00*t.m22*t.m33+t.m02*t.m23*t.m30+t.m03*t.m20*t.m32-t.m00*t.m23*t.m32-t.m02*t.m20*t.m33-t.m03*t.m22*t.m30)*i,n.m12=(t.m00*t.m13*t.m32+t.m02*t.m10*t.m33+t.m03*t.m12*t.m30-t.m00*t.m12*t.m33-t.m02*t.m13*t.m30-t.m03*t.m10*t.m32)*i,n.m13=(t.m00*t.m12*t.m23+t.m02*t.m13*t.m20+t.m03*t.m10*t.m22-t.m00*t.m13*t.m22-t.m02*t.m10*t.m23-t.m03*t.m12*t.m20)*i,n.m20=(t.m10*t.m21*t.m33+t.m11*t.m23*t.m30+t.m13*t.m20*t.m31-t.m10*t.m23*t.m31-t.m11*t.m20*t.m33-t.m13*t.m21*t.m30)*i,n.m21=(t.m00*t.m23*t.m31+t.m01*t.m20*t.m33+t.m03*t.m21*t.m30-t.m00*t.m21*t.m33-t.m01*t.m23*t.m30-t.m03*t.m20*t.m31)*i,n.m22=(t.m00*t.m11*t.m33+t.m01*t.m13*t.m30+t.m03*t.m10*t.m31-t.m00*t.m13*t.m31-t.m01*t.m10*t.m33-t.m03*t.m11*t.m30)*i,n.m23=(t.m00*t.m13*t.m21+t.m01*t.m10*t.m23+t.m03*t.m11*t.m20-t.m00*t.m11*t.m23-t.m01*t.m13*t.m20-t.m03*t.m10*t.m21)*i,n.m30=(t.m10*t.m22*t.m31+t.m11*t.m20*t.m32+t.m12*t.m21*t.m30-t.m10*t.m21*t.m32-t.m11*t.m22*t.m30-t.m12*t.m20*t.m31)*i,n.m31=(t.m00*t.m21*t.m32+t.m01*t.m22*t.m30+t.m02*t.m20*t.m31-t.m00*t.m22*t.m31-t.m01*t.m20*t.m32-t.m02*t.m21*t.m30)*i,n.m32=(t.m00*t.m12*t.m31+t.m01*t.m10*t.m32+t.m02*t.m11*t.m30-t.m00*t.m11*t.m32-t.m01*t.m12*t.m30-t.m02*t.m10*t.m31)*i,n.m33=(t.m00*t.m11*t.m22+t.m01*t.m12*t.m20+t.m02*t.m10*t.m21-t.m00*t.m12*t.m21-t.m01*t.m10*t.m22-t.m02*t.m11*t.m20)*i,n}toString(){return"[["+this.m00+" "+this.m01+" "+this.m02+" "+this.m03+"]\n ["+this.m10+" "+this.m11+" "+this.m12+" "+this.m13+"]\n ["+this.m20+" "+this.m21+" "+this.m22+" "+this.m23+"]\n ["+this.m30+" "+this.m31+" "+this.m32+" "+this.m33+"]]"}toInstanceArray(t,e){return new t(1===e?[this.m00]:4===e?[this.m00,this.m10,this.m01,this.m11]:9===e?[this.m00,this.m10,this.m20,this.m01,this.m11,this.m21,this.m02,this.m12,this.m22]:[this.m00,this.m10,this.m20,this.m30,this.m01,this.m11,this.m21,this.m31,this.m02,this.m12,this.m22,this.m32,this.m03,this.m13,this.m23,this.m33])}}class s{constructor(t,e,s,i){this.x=t,this.y=e,this.z=void 0===s?0:s,this.w=void 0===i?1:i}clone(){return new s(this.x,this.y,this.z,this.w)}negate(){return new s(-this.x,-this.y,-this.z,this.w)}cross(t){return new s(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x,1)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}add(t){return new s(this.x+t.x,this.y+t.y,this.z+t.z,1)}sub(t){return new s(this.x-t.x,this.y-t.y,this.z-t.z,1)}mul(t){if(t instanceof s)return new s(this.x*t.x,this.y*t.y,this.z*t.z,1);if(t instanceof e){const e=this,i=t;return new s(e.x*i.m00+e.y*i.m10+e.z*i.m20+e.w*i.m30,e.x*i.m01+e.y*i.m11+e.z*i.m21+e.w*i.m31,e.x*i.m02+e.y*i.m12+e.z*i.m22+e.w*i.m32,e.x*i.m03+e.y*i.m13+e.z*i.m23+e.w*i.m33)}if("number"==typeof t)return new s(this.x*t,this.y*t,this.z*t,1);throw"IllegalArgumentException"}setX(t){return new s(t,this.y,this.z,this.w)}setY(t){return new s(this.x,t,this.z,this.w)}setZ(t){return new s(this.x,this.y,t,this.w)}setW(t){return new s(this.x,this.y,this.z,t)}max(t){return new s(Math.max(this.x,t.x),Math.max(this.y,t.y),Math.max(this.z,t.z),Math.max(this.w,t.w))}min(t){return new s(Math.min(this.x,t.x),Math.min(this.y,t.y),Math.min(this.z,t.z),Math.min(this.w,t.w))}equals(e){return t.equals(this.x,e.x)&&t.equals(this.y,e.y)&&t.equals(this.z,e.z)&&t.equals(this.w,e.w)}mix(e,i){return new s(t.mix(this.x,e.x,i),t.mix(this.y,e.y,i),t.mix(this.z,e.z,i),t.mix(this.w,e.w,i))}norm(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normFast(){return this.x*this.x+this.y*this.y+this.z*this.z}normalize(){let t=this.normFast();if(0===t)throw"divide error";return t=Math.sqrt(1/t),new s(this.x*t,this.y*t,this.z*t,1)}toString(t){return 1===t?"["+this.x+"]T":2===t?"["+this.x+","+this.y+"]T":3===t?"["+this.x+","+this.y+","+this.z+"]T":"["+this.x+","+this.y+","+this.z+","+this.w+"]T"}toHash(t){const e=1e4;let s=321*parseFloat(this.x.toExponential(3).substring(0,5))&4294967295;return t>=2&&(s=12345*s+parseFloat(this.y.toExponential(4).substring(0,6))*e&4294967295),t>=3&&(s=12345*s+parseFloat(this.z.toExponential(4).substring(0,6))*e&4294967295),t>=4&&(s=12345*s+parseFloat(this.w.toExponential(4).substring(0,6))*e&4294967295),s}toInstanceArray(t,e){return new t(1===e?[this.x]:2===e?[this.x,this.y]:3===e?[this.x,this.y,this.z]:[this.x,this.y,this.z,this.w])}pushed(t,e){1===e?t.push(this.x):2===e?(t.push(this.x),t.push(this.y)):3===e?(t.push(this.x),t.push(this.y),t.push(this.z)):(t.push(this.x),t.push(this.y),t.push(this.z),t.push(this.w))}getDirection(t){return t.sub(this)}getDirectionNormalized(t){return t.sub(this).normalize()}getDistance(t){return this.getDirection(t).norm()}isNaN(){return isNaN(this.x)||isNaN(this.y)||isNaN(this.z)||isNaN(this.w)}isFinite(){return isFinite(this.x)&&isFinite(this.y)&&isFinite(this.z)&&isFinite(this.w)}isRealNumber(){return!this.isNaN()&&this.isFinite()}static getNormalVector(t,e,i,n,r,o){let a;for(;;){const h=t.getDirection(e),m=t.getDirection(i);try{a=h.cross(m).normalize()}catch(t){a=new s(.3333,.3333,.3333);break}if(void 0===n&&void 0===r&&void 0===o)break;const l=n.getDirection(r),c=n.getDirection(o);let u;try{u=1/l.cross(c).z;const t=u*(c.y*h.x-l.y*m.x),e=u*(c.y*h.y-l.y*m.y),i=u*(c.y*h.z-l.y*m.z),n=u*(-c.x*h.x+l.x*m.x),r=u*(-c.x*h.y+l.x*m.y),o=u*(-c.x*h.z+l.x*m.z),d=new s(t,e,i),g=new s(n,r,o);return{normal:a,tangent:d.normalize(),binormal:g.normalize()}}catch(t){break}}return{normal:a,tangent:null,binormal:null}}static isClockwise(t,e,s){const i=t.getDirection(e).setZ(0),n=t.getDirection(s).setZ(0),r=i.cross(n).z;return 0===r?null:r>0}}s.ZERO=new s(0,0,0);class i{constructor(t){this.sys=t,this.init()}init(){this.fovY=45,this.eye=new s(0,0,0),this.at=new s(0,0,1),this.near=1,this.far=1e3}dispose(){this.sys=null,this.fovY=0,this.eye=null,this.at=null,this.near=0,this.far=0}clone(){const t=new i(this.sys);return t.fovY=this.fovY,t.eye=this.eye,t.at=this.at,t.near=this.near,t.far=this.far,t}getVPSMatrix(t){const e=d.calcAspect(t.width,t.height);return{LookAt:this.sys.getMatrixLookAt(this.eye,this.at),aspect:e,PerspectiveFov:this.sys.getMatrixPerspectiveFov(this.fovY,e,this.near,this.far),Viewport:this.sys.getMatrixViewport(0,0,t.width,t.height)}}setDrawRange(t,e){this.near=t,this.far=e}setFovY(t){this.fovY=t}setEye(t){this.eye=t.clone()}setCenter(t){this.at=t.clone()}getDirection(){return this.eye.getDirectionNormalized(this.at)}getDistance(){return this.at.getDistance(this.eye)}setDistance(t){const e=this.at.getDirectionNormalized(this.eye);this.eye=this.at.add(e.mul(t))}getRotateY(){const e=this.at.getDirection(this.eye);return t.degrees(Math.atan2(e.x,e.z))}setRotateY(e){const i=t.radius(e),n=this.at.getDirection(this.eye).setY(0).norm(),r=Math.cos(i),o=Math.sin(i);this.eye=new s(this.at.x+n*o,this.eye.y,this.at.z+n*r)}addRotateY(t){this.setRotateY(this.getRotateY()+t)}getRotateX(){const e=this.at.getDirection(this.eye);return t.degrees(Math.atan2(e.z,e.y))}setRotateX(e){const i=t.radius(e),n=this.at.getDirection(this.eye).setX(0).norm(),r=Math.cos(i),o=Math.sin(i);this.eye=new s(this.eye.x,this.at.y+n*r,this.at.z+n*o)}addRotateX(t){this.setRotateX(this.getRotateX()+t)}translateAbsolute(t){this.eye=this.eye.add(t),this.at=this.at.add(t)}translateRelative(t){let e,i,n;const r=new s(0,1,0);n=this.eye.getDirectionNormalized(this.at),this.sys.dimensionmode===d.DIMENSION_MODE.RIGHT_HAND&&(n=n.negate()),e=r.cross(n).normalize(),i=n.cross(e),e=e.mul(t.x),i=i.mul(t.y),n=n.mul(t.z),this.translateAbsolute(e.add(i).add(n))}toString(){return"camera[\neye  :"+this.eye+",\nat   :"+this.at+",\nfovY :"+this.fovY+"]"}}class n{constructor(){this.init()}init(){this.mode=n.MODE.DIRECTIONAL_LIGHT,this.power=1,this.range=1e3,this.position=new s(0,0,0),this.direction=new s(0,0,-1),this.color=new s(1,1,1)}clone(t){t||(t=n);const e=new t;return e.mode=this.mode,e.power=this.power,e.range=this.range,e.position=this.position,e.direction=this.direction,e.color=this.color,e}setMode(t){this.mode=t}setPower(t){this.power=t}setRange(t){this.range=t}setPosition(t){this.position=t}setDirection(t){this.direction=t}setColor(t){this.color=t}}n.MODE={NONE:0,AMBIENT_LIGHT:1,DIRECTIONAL_LIGHT:2,POINT_LIGHT:3};class r{constructor(t,e){this.sys=t,this._init(),void 0!==e&&this.setImage(e)}_init(){this.url=null,this.image=null,this.is_loadimage=!1,this.is_dispose=!1}dispose(){this.is_dispose||(this.is_dispose=!0)}setImage(t){if(null!==t&&!this.is_dispose){if(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement){const e=t.width,s=t.height,i=function(t){const e=Math.log(t)/Math.log(2);return e-Math.floor(e)<1e-10?t:1<<Math.ceil(e)},n=i(e),r=i(s);if(e!==n||s!==r){const i=document.createElement("canvas");i.width=n,i.height=r,i.getContext("2d").drawImage(t,0,0,e,s,0,0,n,r),t=i}}if(t instanceof ImageData||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)return null===this.url&&(this.url=this.sys._createID()),this.image=t,void(this.is_loadimage=!0);if("string"!=typeof t)console.log("not setImage"),console.log(t);else{this.url=t;const e=this;this.sys._download(this.url,(function(t){e.setImage(t)}))}}}}class o{constructor(t,e){this.sys=t,this.name="s3default",void 0!==e&&(this.name=e),this.color=new s(1,1,1,1),this.diffuse=.8,this.emission=new s(0,0,0),this.specular=new s(0,0,0),this.power=5,this.ambient=new s(.6,.6,.6),this.reflect=0,this.textureColor=this.sys.createTexture(),this.textureNormal=this.sys.createTexture()}dispose(){}setName(t){this.name=t}setColor(t){this.color=this.sys._toVector3(t)}setDiffuse(t){this.diffuse=this.sys._toValue(t)}setEmission(t){this.emission=this.sys._toVector3(t)}setSpecular(t){this.specular=this.sys._toVector3(t)}setPower(t){this.power=this.sys._toValue(t)}setAmbient(t){this.ambient=this.sys._toVector3(t)}setReflect(t){this.reflect=this.sys._toValue(t)}setTextureColor(t){null!==this.textureColor&&this.textureColor.dispose(),this.textureColor=this.sys.createTexture(),this.textureColor.setImage(t)}setTextureNormal(t){null!==this.textureNormal&&this.textureNormal.dispose(),this.textureNormal=this.sys.createTexture(),this.textureNormal.setImage(t)}}class a{constructor(t){this.position=t}clone(t){return t||(t=a),new t(this.position)}}class h{constructor(t,e,s,i,n,r){this._init(t,e,s,i,n,r)}_init(t,e,i,n,r,o){if(this.index=null,this.uv=null,this.materialIndex=null,!(n instanceof Array&&n.length>0))throw"IllegalArgumentException";this.index=[n[t],n[e],n[i]],void 0!==o&&o instanceof Array&&o.length>0&&o[0]instanceof s?this.uv=[o[t],o[e],o[i]]:this.uv=[null,null,null],r=(r=r||0)>=0?r:0,this.materialIndex=r}clone(t){return t||(t=h),new t(0,1,2,this.index,this.materialIndex,this.uv)}inverseTriangle(t){return t||(t=h),new t(2,1,0,this.index,this.materialIndex,this.uv)}}class m{constructor(t){this.sys=t,this._init()}_init(){this.src={vertex:[],triangleindex:[],material:[]},this.is_complete=!1}isComplete(){return this.is_complete}clone(t){t||(t=m);const e=new t(this.sys);return e.addVertex(this.getVertexArray()),e.addTriangleIndex(this.getTriangleIndexArray()),e.addMaterial(this.getMaterialArray()),e}setComplete(t){this.is_complete=t}setInverseTriangle(t){this.setComplete(!1),this.is_inverse=t}getVertexArray(){return this.src.vertex}getTriangleIndexArray(){return this.src.triangleindex}getMaterialArray(){return this.src.material}addVertex(t){this.setComplete(!1);const e=this.getVertexArray();if(void 0===t);else if(t instanceof a)e[e.length]=t;else for(let s=0;s<t.length;s++)e[e.length]=t[s]}addTriangleIndex(t){this.setComplete(!1);const e=this.getTriangleIndexArray();if(void 0===t);else if(t instanceof h)e[e.length]=this.is_inverse?t.inverseTriangle():t;else for(let s=0;s<t.length;s++)e[e.length]=this.is_inverse?t[s].inverseTriangle():t[s]}addMaterial(t){this.setComplete(!1);const e=this.getMaterialArray();if(void 0===t);else if(t instanceof o)e[e.length]=t;else for(let s=0;s<t.length;s++)e[e.length]=t[s]}}class l{constructor(t,e,s){3===arguments.length?this.setRotateZXY(t,e,s):(this.roll=0,this.pitch=0,this.yaw=0)}static _toPeriodicAngle(t){return t>l.PI?t-l.PI2*~~((t+l.PI)/l.PI2):t<-l.PI?t+l.PI2*~~((-t+l.PI)/l.PI2):t}clone(){return new l(this.roll,this.pitch,this.yaw)}setRotateZXY(t,e,s){this.roll=l._toPeriodicAngle(isNaN(t)?0:t),this.pitch=l._toPeriodicAngle(isNaN(e)?0:e),this.yaw=l._toPeriodicAngle(isNaN(s)?0:s)}addRotateX(t){return new l(this.roll,this.pitch+t,this.yaw)}addRotateY(t){return new l(this.roll,this.pitch,this.yaw+t)}addRotateZ(t){return new l(this.roll+t,this.pitch,this.yaw)}setRotateX(t){return new l(this.roll,t,this.yaw)}setRotateY(t){return new l(this.roll,this.pitch,t)}setRotateZ(t){return new l(t,this.pitch,this.yaw)}toString(){return"angles["+this.roll+","+this.pitch+","+this.yaw+"]"}}l.PI=180,l.PIOVER2=l.PI/2,l.PILOCK=l.PIOVER2-1e-4,l.PI2=2*l.PI;class c{constructor(){this._init()}_init(){this.angles=new l,this.scale=new s(1,1,1),this.position=new s(0,0,0),this.mesh=null}setMesh(t){this.mesh=t}getMesh(){return this.mesh}setScale(t,e,i){if(1===arguments.length)"number"==typeof t?this.scale=new s(t,t,t):t instanceof s&&(this.scale=t);else{if("number"!=typeof t||"number"!=typeof e||"number"!=typeof i)throw new TypeError("setScale(x, y, z): All arguments must be numbers.");this.scale=new s(t,e,i)}}getScale(){return this.scale}setPosition(t,e,i){if(1===arguments.length&&t instanceof s)this.position=t;else{if("number"!=typeof t||"number"!=typeof e||"number"!=typeof i)throw new TypeError("setPosition(x, y, z): All arguments must be numbers.");this.position=new s(t,e,i)}}getPosition(){return this.position}getAngle(){return this.angles}setAngle(t){this.angles=t}addRotateX(t){this.angles=this.angles.addRotateX(t)}addRotateY(t){this.angles=this.angles.addRotateY(t)}addRotateZ(t){this.angles=this.angles.addRotateZ(t)}setRotateX(t){this.angles=this.angles.setRotateX(t)}setRotateY(t){this.angles=this.angles.setRotateY(t)}setRotateZ(t){this.angles=this.angles.addRotateZ(t)}}class u{constructor(){this._init()}_init(){this.camera=null,this.model=[],this.light=[]}empty(){this.model=[],this.light=[]}setCamera(t){this.camera=t.clone()}addModel(t){this.model[this.model.length]=t}addLight(t){this.light[this.light.length]=t}getCamera(){return this.camera}getModels(){return this.model}getLights(){return this.light}}class d{constructor(){this._init()}_init(){this.setSystemMode(d.SYSTEM_MODE.OPEN_GL),this.setBackgroundColor(new s(1,1,1,1))}_createID(){void 0===this._CREATE_ID1&&(this._CREATE_ID1=0,this._CREATE_ID2=0,this._CREATE_ID3=0,this._CREATE_ID4=0);const t=this._CREATE_ID4.toString(16)+":"+this._CREATE_ID3.toString(16)+":"+this._CREATE_ID2.toString(16)+":"+this._CREATE_ID1.toString(16);if(this._CREATE_ID1++,4294967296===this._CREATE_ID1&&(this._CREATE_ID1=0,this._CREATE_ID2++,4294967296===this._CREATE_ID2&&(this._CREATE_ID2=0,this._CREATE_ID3++,4294967296===this._CREATE_ID3&&(this._CREATE_ID3=0,this._CREATE_ID4++,4294967296===this._CREATE_ID4))))throw this._CREATE_ID4=0,"createID";return t}_download(t,e){const s=t.split(".");let i=!1;if(s.length>1){const t=s[s.length-1].toLocaleString();i="gif"===t||"jpg"===t||"png"===t||"bmp"===t||"svg"===t||"jpeg"===t}if(i){const s=new Image;return s.onload=function(){e(s,"")},void(s.src=t)}const n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState){if(200!==n.status)return console.log("error download ["+t+"]"),null;e(n.responseText,"")}},n.open("GET",t,!0),n.send(null)}_toVector3(t){if(t instanceof s)return t;if("number"==typeof t)return new s(t,t,t);if(t instanceof Array)return new s(t[0],t[1],t[2]);throw"IllegalArgumentException"}_toValue(t){if(isNaN(t))throw"IllegalArgumentException";return t}setBackgroundColor(t){this.backgroundColor=t}getBackgroundColor(){return this.backgroundColor}setSystemMode(t){this.systemmode=t,this.systemmode===d.SYSTEM_MODE.OPEN_GL?(this.depthmode=d.DEPTH_MODE.OPEN_GL,this.dimensionmode=d.DIMENSION_MODE.RIGHT_HAND,this.vectormode=d.VECTOR_MODE.VECTOR4x1,this.frontface=d.FRONT_FACE.COUNTER_CLOCKWISE,this.cullmode=d.CULL_MODE.BACK):(this.depthmode=d.DEPTH_MODE.DIRECT_X,this.dimensionmode=d.DIMENSION_MODE.LEFT_HAND,this.vectormode=d.VECTOR_MODE.VECTOR1x4,this.frontface=d.FRONT_FACE.CLOCKWISE,this.cullmode=d.CULL_MODE.BACK)}setDepthMode(t){this.depthmode=t}setDimensionMode(t){this.dimensionmode=t}setVectorMode(t){this.vectormode=t}setFrontMode(t){this.frontface=t}setCullMode(t){this.cullmode=t}setCanvas(t){const e=this,s=t.getContext("2d");this.canvas=t,this.context2d={context:s,drawLine:function(t,e){s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(e.x,e.y),s.stroke()},drawLinePolygon:function(t,e,i){s.beginPath(),s.moveTo(t.x,t.y),s.lineTo(e.x,e.y),s.lineTo(i.x,i.y),s.closePath(),s.stroke()},setLineWidth:function(t){s.lineWidth=t},setLineColor:function(t){s.strokeStyle=t},clear:function(){const t=e.getBackgroundColor();s.clearRect(0,0,e.canvas.width,e.canvas.height),s.fillStyle="rgba("+255*t.x+","+255*t.y+","+255*t.z+","+t.w+")",s.fillRect(0,0,e.canvas.width,e.canvas.height)}}}testCull(t,e,i){if(this.cullmode===d.CULL_MODE.NONE)return!1;if(this.cullmode===d.CULL_MODE.FRONT_AND_BACK)return!0;const n=s.isClockwise(t,e,i);return null===n||(n?this.frontface===d.FRONT_FACE.CLOCKWISE?this.cullmode===d.CULL_MODE.BACK:this.cullmode===d.CULL_MODE.FRONT:this.frontface===d.FRONT_FACE.CLOCKWISE?this.cullmode!==d.CULL_MODE.BACK:this.cullmode!==d.CULL_MODE.FRONT)}getMatrixViewport(t,s,i,n,r,o){void 0===r&&(r=0),void 0===o&&(o=1);const a=new e;return a.m00=i/2,a.m01=0,a.m02=0,a.m03=0,a.m10=0,a.m11=-n/2,a.m12=0,a.m13=0,a.m20=0,a.m21=0,a.m22=1,a.m23=1,a.m30=t+i/2,a.m31=s+n/2,a.m32=0,a.m33=1,this.depthmode===d.DEPTH_MODE.DIRECT_X?(a.m22=r-o,a.m32=r):this.depthmode===d.DEPTH_MODE.OPEN_GL&&(a.m22=(r-o)/2,a.m32=(r+o)/2),this.vectormode===d.VECTOR_MODE.VECTOR4x1?a.transposed():a}static calcFovY(t){return 2*Math.atan(1/t)}static calcAspect(t,e){return t/e}getMatrixPerspectiveFov(s,i,n,r){const o=t.radius(s),a=1/Math.tan(o/2),h=a/i,m=new e;m.m00=h,m.m01=0,m.m02=0,m.m03=0,m.m10=0,m.m11=a,m.m12=0,m.m13=0,m.m20=0,m.m21=0,m.m22=1,m.m23=1,m.m30=0,m.m31=0,m.m32=0,m.m33=0;const l=r-n;if(n>r)throw"Near > Far error";if(0===l)throw"divide error";return this.depthmode===d.DEPTH_MODE.DIRECT_X?(m.m22=r/l,m.m32=-r*n/l):this.depthmode===d.DEPTH_MODE.OPEN_GL&&(m.m22=(r+n)/l,m.m32=-2*r*n/l),this.dimensionmode===d.DIMENSION_MODE.RIGHT_HAND&&(m.m22=-m.m22,m.m23=-m.m23),this.vectormode===d.VECTOR_MODE.VECTOR4x1?m.transposed():m}getMatrixLookAt(t,i,n){void 0===n&&(n=new s(0,1,0));let r=t.getDirectionNormalized(i);this.dimensionmode===d.DIMENSION_MODE.RIGHT_HAND&&(r=r.negate());const o=n.cross(r).normalize(),a=r.cross(o),h=new e;return h.m00=o.x,h.m01=a.x,h.m02=r.x,h.m03=0,h.m10=o.y,h.m11=a.y,h.m12=r.y,h.m13=0,h.m20=o.z,h.m21=a.z,h.m22=r.z,h.m23=0,h.m30=-o.dot(t),h.m31=-a.dot(t),h.m32=-r.dot(t),h.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?h.transposed():h}getMatrixIdentity(){const t=new e;return t.m00=1,t.m01=0,t.m02=0,t.m03=0,t.m10=0,t.m11=1,t.m12=0,t.m13=0,t.m20=0,t.m21=0,t.m22=1,t.m23=0,t.m30=0,t.m31=0,t.m32=0,t.m33=1,t}getMatrixTranslate(t,s,i){const n=new e;return n.m00=1,n.m01=0,n.m02=0,n.m03=0,n.m10=0,n.m11=1,n.m12=0,n.m13=0,n.m20=0,n.m21=0,n.m22=1,n.m23=0,n.m30=t,n.m31=s,n.m32=i,n.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?n.transposed():n}getMatrixScale(t,s,i){const n=new e;return n.m00=t,n.m01=0,n.m02=0,n.m03=0,n.m10=0,n.m11=s,n.m12=0,n.m13=0,n.m20=0,n.m21=0,n.m22=i,n.m23=0,n.m30=0,n.m31=0,n.m32=0,n.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?n.transposed():n}getMatrixRotateX(s){const i=t.radius(s),n=Math.cos(i),r=Math.sin(i),o=new e;return o.m00=1,o.m01=0,o.m02=0,o.m03=0,o.m10=0,o.m11=n,o.m12=r,o.m13=0,o.m20=0,o.m21=-r,o.m22=n,o.m23=0,o.m30=0,o.m31=0,o.m32=0,o.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?o.transposed():o}getMatrixRotateY(s){const i=t.radius(s),n=Math.cos(i),r=Math.sin(i),o=new e;return o.m00=n,o.m01=0,o.m02=-r,o.m03=0,o.m10=0,o.m11=1,o.m12=0,o.m13=0,o.m20=r,o.m21=0,o.m22=n,o.m23=0,o.m30=0,o.m31=0,o.m32=0,o.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?o.transposed():o}getMatrixRotateZ(s){const i=t.radius(s),n=Math.cos(i),r=Math.sin(i),o=new e;return o.m00=n,o.m01=r,o.m02=0,o.m03=0,o.m10=-r,o.m11=n,o.m12=0,o.m13=0,o.m20=0,o.m21=0,o.m22=1,o.m23=0,o.m30=0,o.m31=0,o.m32=0,o.m33=1,this.vectormode===d.VECTOR_MODE.VECTOR4x1?o.transposed():o}mulMatrix(t,e){return this.vectormode===d.VECTOR_MODE.VECTOR4x1?e.mulMatrix(t):t.mulMatrix(e)}mulVector(t,e){return this.vectormode===d.VECTOR_MODE.VECTOR4x1?t.mulVector(e):e.mul(t)}getMatrixRotateZXY(t,e,s){const i=this.getMatrixRotateZ(t),n=this.getMatrixRotateX(e),r=this.getMatrixRotateY(s);return this.mulMatrix(this.mulMatrix(i,n),r)}getMatrixWorldTransform(t){const e=this.getMatrixRotateZXY(t.angles.roll,t.angles.pitch,t.angles.yaw),s=this.getMatrixScale(t.scale.x,t.scale.y,t.scale.z),i=this.getMatrixTranslate(t.position.x,t.position.y,t.position.z);return this.mulMatrix(this.mulMatrix(s,e),i)}clear(){this.context2d.clear()}_calcVertexTransformation(t,e,s){const i=[];for(let n=0;n<t.length;n++){let r=t[n].position;r=this.mulVector(e,r);const o=r.w;r=r.mul(1/o),r=this.mulVector(s,r),i[n]=new a(r)}return i}drawAxis(t){const e=t.getCamera().getVPSMatrix(this.canvas),i=[];i[0]=new s(0,0,0),i[1]=new s(10,0,0),i[2]=new s(0,10,0),i[3]=new s(0,0,10);const n=[],r=this.mulMatrix(e.LookAt,e.PerspectiveFov);for(let t=0;t<i.length;t++){let s=i[t];s=this.mulVector(r,s),s=s.mul(1/s.w),s=this.mulVector(e.Viewport,s),n[t]=s}this.context2d.setLineWidth(3),this.context2d.setLineColor("rgb(255, 0, 0)"),this.context2d.drawLine(n[0],n[1]),this.context2d.setLineColor("rgb(0, 255, 0)"),this.context2d.drawLine(n[0],n[2]),this.context2d.setLineColor("rgb(0, 0, 255)"),this.context2d.drawLine(n[0],n[3])}_drawPolygon(t,e){for(let s=0;s<e.length;s++){const i=e[s];this.testCull(t[i.index[0]].position,t[i.index[1]].position,t[i.index[2]].position)||this.context2d.drawLinePolygon(t[i.index[0]].position,t[i.index[1]].position,t[i.index[2]].position)}}drawScene(t){const e=t.getCamera().getVPSMatrix(this.canvas);this.context2d.setLineWidth(1),this.context2d.setLineColor("rgb(0, 0, 0)");const s=t.getModels();for(let t=0;t<s.length;t++){const i=s[t],n=i.getMesh();if(!1===n.isComplete())continue;const r=this.getMatrixWorldTransform(i),o=this.mulMatrix(this.mulMatrix(r,e.LookAt),e.PerspectiveFov),a=this._calcVertexTransformation(n.src.vertex,o,e.Viewport);this._drawPolygon(a,n.src.triangleindex)}}_disposeObject(){}createVertex(t){return new a(t)}createTriangleIndex(t,e,s,i,n,r){return new h(t,e,s,i,n,r)}createTexture(t){return new r(this,t)}createScene(){return new u}createModel(){return new c}createMesh(){return new m(this)}createMaterial(t){return new o(this,t)}createLight(){return new n}createCamera(){return new i(this)}}d.SYSTEM_MODE={OPEN_GL:0,DIRECT_X:1},d.DEPTH_MODE={OPEN_GL:0,DIRECT_X:1},d.DIMENSION_MODE={RIGHT_HAND:0,LEFT_HAND:1},d.VECTOR_MODE={VECTOR4x1:0,VECTOR1x4:1},d.FRONT_FACE={COUNTER_CLOCKWISE:0,CLOCKWISE:1},d.CULL_MODE={NONE:0,FRONT:1,BACK:2,FRONT_AND_BACK:3};class g{constructor(t,i,n){if(t instanceof n.instance)this.data=t;else if(t instanceof s||t instanceof e)this.data=t.toInstanceArray(n.instance,i);else if(t instanceof Array||t instanceof Float32Array||t instanceof Int32Array)this.data=new n.instance(t);else{if(isNaN(t))throw"IllegalArgumentException";this.data=new n.instance([t])}this.dimension=i,this.datatype=n;let r="";r=t instanceof s?"S3Vector":t instanceof e?"S3Matrix":"Number",this.glsltype=g.gltypetable[n.name][r][i]}}g.datatype={Float32Array:{instance:Float32Array,name:"Float32Array"},Int32Array:{instance:Int32Array,name:"Int32Array"}},g.gltypetable={Float32Array:{Number:{1:"float",2:"vec2",3:"vec3",4:"vec4"},S3Vector:{2:"vec2",3:"vec3",4:"vec4"},S3Matrix:{4:"mat2",9:"mat3",16:"mat4"}},Int32Array:{Number:{1:"int",2:"ivec2",3:"ivec3",4:"ivec4"},S3Vector:{2:"ivec2",3:"ivec3",4:"ivec4"}}};class f{constructor(t,e){this._init(t,e)}_init(t,e){this.sys=t,this.code=null,this.shader=null,this.sharder_type=-1,this.is_error=!1;const s=this,i=function(t){s.code=t};-1===e.indexOf("\n")?this.sys._download(e,i):this.code=e}isError(){return this.is_error}getCode(){return this.code}getShader(){const t=this.sys.getGL();if(null===t||this.is_error||null===this.code)return null;if(null!==this.shader)return this.shader;let e=this.code;e=e.replace(/\/\/.*/g,""),e=e.replace(/\/\*([^*]|\*[^/])*\*\//g,"");let s=0;s=-1!==e.indexOf("gl_FragColor")?t.FRAGMENT_SHADER:t.VERTEX_SHADER;const i=this.sys.glfunc.createShader(s,e);return i.is_error?(this.is_error=!0,null):(this.shader=i.shader,this.sharder_type=s,this.shader)}getShaderType(){return-1!==this.sharder_type||null!==this.getShader()?this.sharder_type:null}dispose(){return null===this.sys.getGL()?null:(null===this.shader||(this.sys.glfunc.deleteShader(this.shader),this.shader=null,this.sharder_type=-1),!0)}}class p extends r{constructor(t,e){super(t,e),this._s3gl=t,this.gldata=null}_init(){super._init(),this.gldata=null}dispose(){this.is_dispose||(this.is_dispose=!0,null!==this.gldata&&(this._s3gl._disposeObject(this),this.gldata=null))}getGLData(){return this.is_dispose?null:null!==this.gldata?this.gldata:this.is_loadimage?(this.gldata=this._s3gl.glfunc.createTexture(this.url,this.image),this.gldata):null}}class y extends m{constructor(t){super(t)}_init(){super._init(),this.gldata={},this.is_compile_gl=!1}clone(){return super.clone(y)}isCompileGL(){return this.is_compile_gl}setCompileGL(t){this.is_compile_gl=t}createTriangleIndexData(){const t=this.getVertexArray(),e=this.getTriangleIndexArray(),i=[],n={normal:null,tangent:null,binormal:null};for(let r=0;r<e.length;r++){const o=e[r],a=o.index,h=o.uv;i[r]=o.createGLTriangleIndexData();const m=i[r];let l=null;l=this.sys.dimensionmode===d.DIMENSION_MODE.RIGHT_HAND?s.getNormalVector(t[a[0]].position,t[a[1]].position,t[a[2]].position,h[0],h[1],h[2]):s.getNormalVector(t[a[2]].position,t[a[1]].position,t[a[0]].position,h[2],h[1],h[0]);for(const t in n)m.face[t]=l[t]}const r=[],o=[];for(let t=0;t<e.length;t++){const a=e[t],h=a.materialIndex,m=i[t];void 0===r[h]&&(r[h]=[],o[h]=[]);const l=r[h],c=o[h];for(let t=0;t<3;t++){const e=a.index[t];void 0===l[e]&&(l[e]={normal:new s(0,0,0),tangent:new s(0,0,0),binormal:new s(0,0,0)},c[e]={normal:[],tangent:[],binormal:[]});const i=l[e],r=c[e];for(const t in n)if(null!==m.face[t]){const e=m.face[t].toHash(3);if(r[t][e])continue;i[t]=i[t].add(m.face[t]),r[t][e]=!0}}}for(const t in r){const e=r[t];for(const t in e){const s=e[t];for(const t in n)s[t].normFast()>1e-6&&(s[t]=s[t].normalize())}}const a={};a.normal=Math.cos(50/360*(2*Math.PI)),a.tangent=Math.cos(50/360*(2*Math.PI)),a.binormal=Math.cos(50/360*(2*Math.PI));for(let t=0;t<e.length;t++){const s=e[t],o=s.materialIndex,h=i[t],m=r[o];for(let t=0;t<3;t++){const e=m[s.index[t]];for(const s in n){let i;if(h.face[s]){i=h.face[s].dot(e[s])<a[s]?h.face:e}else i=e;h.vertex[s][t]=i[s]}}}return i}_getGLArrayData(){const t=this.getVertexArray(),e=this.createTriangleIndexData(),s=[];let i=0;const n=[],r={};for(let o=0;o<e.length;o++){const a=e[o],h=[];for(let e=0;e<3;e++){const n=a.getGLHash(e,t),o=s[n];if(h[e]=void 0!==o?o:i,void 0===o){const o=a.getGLData(e,t);s[n]=i;for(const t in o)void 0===r[t]&&(r[t]=[]),r[t].push(o[t]);i++}}n[o]=new Int16Array(h)}let o=0;const a={};a.array_length=3*e.length,a.array=new Int16Array(a.array_length),o=0;for(let t=0;t<e.length;t++)for(let e=0;e<3;e++)a.array[o++]=n[t][e];const h={};for(const t in r){const e=r[t],s=e[0].dimension,n={};n.name=t,n.dimension=e[0].dimension,n.datatype=e[0].datatype,n.array_length=s*i,n.array=new n.datatype.instance(n.array_length),o=0;for(let t=0;t<i;t++)for(let i=0;i<s;i++)n.array[o++]=e[t].data[i];h[t]=n}const m={};return m.ibo=a,m.vbo=h,m}disposeGLData(){if(!this.isCompileGL())return;const t=this.getGLData();if(null!==t){if(void 0!==t.ibo&&(void 0!==t.ibo.data&&this.sys.glfunc.deleteBuffer(t.ibo.data),delete t.ibo),void 0!==t.vbo){for(const e in t.vbo)void 0!==t.vbo[e].data&&this.sys.glfunc.deleteBuffer(t.vbo[e].data);delete t.vbo}{const t=this.getMaterialArray();for(let e=0;e<t.length;e++){const s=t[e];for(const t in s){const e=s[t];e instanceof p&&e.dispose()}}}}delete this.gldata,this.gldata={},this.setCompileGL(!1)}getGLData(){if(this.isCompileGL())return this.gldata;if(!1===this.isComplete())return null;if(!this.sys.isSetGL())return null;const t=this._getGLArrayData();t.ibo.data=this.sys.glfunc.createBufferIBO(t.ibo.array);for(const e in t.vbo)t.vbo[e].data=this.sys.glfunc.createBufferVBO(t.vbo[e].array);return this.gldata=t,this.setCompileGL(!0),this.gldata}}class _{constructor(t,e){this._init(t,e)}_init(t,e){this.id=e,this.sys=t,this.vertex=null,this.fragment=null,this.isDLVertex=!1,this.isDLFragment=!1,this.program=null,this.is_linked=!1,this.is_error=!1,this.enable_vertex_number={},this.variable={};const s=this;this.activeTextureId=0;const i={uniform1iv:function(e,s){t.getGL()&&t.getGL().uniform1iv(e,s)},uniform2iv:function(e,s){t.getGL()&&t.getGL().uniform2iv(e,s)},uniform3iv:function(e,s){t.getGL()&&t.getGL().uniform3iv(e,s)},uniform4iv:function(e,s){t.getGL()&&t.getGL().uniform4iv(e,s)},uniform1fv:function(e,s){t.getGL()&&t.getGL().uniform1fv(e,s)},uniform2fv:function(e,s){t.getGL()&&t.getGL().uniform2fv(e,s)},uniform3fv:function(e,s){t.getGL()&&t.getGL().uniform3fv(e,s)},uniform4fv:function(e,s){t.getGL()&&t.getGL().uniform4fv(e,s)},uniformMatrix2fv:function(e,s){t.getGL()&&t.getGL().uniformMatrix2fv(e,!1,s)},uniformMatrix3fv:function(e,s){t.getGL()&&t.getGL().uniformMatrix3fv(e,!1,s)},uniformMatrix4fv:function(e,s){t.getGL()&&t.getGL().uniformMatrix4fv(e,!1,s)},uniformSampler2D:function(e,i){const n=t.getGL();n&&(n.activeTexture(n.TEXTURE0+s.activeTextureId),n.bindTexture(n.TEXTURE_2D,i),n.uniform1i(e,s.activeTextureId),s.activeTextureId++)}},n={int:{glsltype:"int",instance:Int32Array,size:1,btype:"INT",bind:i.uniform1iv},float:{glsltype:"float",instance:Float32Array,size:1,btype:"FLOAT",bind:i.uniform1fv},bool:{glsltype:"bool",instance:Int32Array,size:1,btype:"INT",bind:i.uniform1iv},mat2:{glsltype:"mat2",instance:Float32Array,size:4,btype:"FLOAT",bind:i.uniformMatrix2fv},mat3:{glsltype:"mat3",instance:Float32Array,size:9,btype:"FLOAT",bind:i.uniformMatrix3fv},mat4:{glsltype:"mat4",instance:Float32Array,size:16,btype:"FLOAT",bind:i.uniformMatrix4fv},vec2:{glsltype:"vec2",instance:Float32Array,size:2,btype:"FLOAT",bind:i.uniform2fv},vec3:{glsltype:"vec3",instance:Float32Array,size:3,btype:"FLOAT",bind:i.uniform3fv},vec4:{glsltype:"vec4",instance:Float32Array,size:4,btype:"FLOAT",bind:i.uniform4fv},ivec2:{glsltype:"ivec2",instance:Int32Array,size:2,btype:"INT",bind:i.uniform2iv},ivec3:{glsltype:"ivec3",instance:Int32Array,size:3,btype:"INT",bind:i.uniform3iv},ivec4:{glsltype:"ivec4",instance:Int32Array,size:4,btype:"INT",bind:i.uniform4iv},bvec2:{glsltype:"bvec2",instance:Int32Array,size:2,btype:"INT",bind:i.uniform2iv},bvec3:{glsltype:"bvec3",instance:Int32Array,size:3,btype:"INT",bind:i.uniform3iv},bvec4:{glsltype:"bvec4",instance:Int32Array,size:4,btype:"INT",bind:i.uniform4iv},sampler2D:{glsltype:"sampler2D",instance:Image,size:1,btype:"TEXTURE",bind:i.uniformSampler2D},samplerCube:{glsltype:"samplerCube",instance:Image,size:1,btype:"TEXTURE",bind:null}};this.analysisShader=function(t,e){const s=(t=(t=t.replace(/\/\/.*/g,"")).replace(/\/\*([^*]|\*[^/])*\*\//g,"")).split("\n");for(let t=0;t<s.length;t++){const i=s[t].match(/(attribute|uniform)\s+(\w+)\s+(\w+)\s*(\[\s*\w+\s*\])?;/);if(null===i)continue;const r=i[1],o=i[2],a=i[3],h=void 0!==i[4],m=n[o];e[a]={glsltype:m.glsltype,instance:m.instance,size:m.size,btype:m.btype,bind:m.bind,name:a,modifiers:r,is_array:h,location:[]}}}}resetActiveTextureId(){this.activeTextureId=0}isLinked(){return this.is_linked}dispose(){return null!==this.sys.getGL()&&(this.is_linked&&(this.disuseProgram(),this.sys.glfunc.deleteProgram(this.program,this.vertex.getShader(),this.fragment.getShader()),this.program=null,this.is_linked=!1),null!==this.vertex&&(this.vertex.dispose(),this.vertex=null),null!==this.fragment&&(this.fragment.dispose(),this.fragment=null),this._init(this.sys,this.id),!0)}setVertexShader(t){return!this.isLinked()&&(null!==this.vertex&&(this.vertex.dispose(),this.vertex=null),this.vertex=new f(this.sys,t),this.is_error=!1,!0)}setFragmentShader(t){return!this.isLinked()&&(null!==this.fragment&&(this.fragment.dispose(),this.fragment=null),this.fragment=new f(this.sys,t),this.is_error=!1,!0)}useProgram(){if(!this.isLinked())return!1;const t=this.getProgram();return t&&this.sys.getGL()&&this.sys.getGL().useProgram(t),!0}disuseProgram(){if(!this.isLinked())return!1;const t=this.sys.getGL();if(t){for(const e in this.enable_vertex_number)t.disableVertexAttribArray(e);this.enable_vertex_number={}}return!0}getProgram(){const t=this.sys.getGL();if(null===t||this.is_error)return null;if(this.isDLVertex||this.isDLFragment)return null;if(this.isLinked())return this.program;if(null===this.vertex)return console.log("do not set VERTEX_SHADER"),this.is_error=!0,null;if(null===this.fragment)return console.log("do not set FRAGMENT_SHADER"),this.is_error=!0,null;const e=this.vertex.isError(),s=this.fragment.isError();if(e||s)return console.log("shader compile error"),this.is_error=!0,null;const i=this.vertex.getShader(),n=this.fragment.getShader();if(null===i||null===n)return null;if(this.vertex.getShaderType()!==t.VERTEX_SHADER)return console.log("VERTEX_SHADER is not VERTEX_SHADER"),this.is_error=!0,null;if(this.fragment.getShaderType()!==t.FRAGMENT_SHADER)return console.log("FRAGMENT_SHADER is not FRAGMENT_SHADER"),this.is_error=!0,null;const r=this.sys.glfunc.createProgram(i,n);return r.is_error?(this.is_error=!0,null):(this.is_linked=!0,this.program=r.program,this.analysisShader(this.vertex.getCode(),this.variable),this.analysisShader(this.fragment.getCode(),this.variable),this.program)}bindData(t,i){if(!this.isLinked())return!1;const n=this.sys.getGL(),r=this.getProgram(),o=this.variable[t];if(void 0===o)return!1;if(0===o.location.length)if("attribute"===o.modifiers)o.location[0]=n.getAttribLocation(r,t);else if(o.is_array){if(Array.isArray(i))for(let e=0;e<i.length;e++)o.location[e]=n.getUniformLocation(r,t+"["+e+"]")}else o.location[0]=n.getUniformLocation(r,t);if(-1===o.location[0])return!1;const a=function(t){if(t instanceof WebGLBuffer&&"attribute"===o.modifiers)return t;if(t instanceof WebGLTexture&&"sampler2D"===o.glsltype)return t;if(t instanceof o.instance)return t;if(t instanceof g&&o.glsltype===t.glsltype)return t.data;if(o.instance===Float32Array||o.instance===Int32Array){if(t instanceof e&&("mat2"===o.glsltype||"mat3"===o.glsltype||"mat4"===o.glsltype))return t.toInstanceArray(o.instance,o.size);if(t instanceof s&&("vec2"===o.glsltype||"vec3"===o.glsltype||"vec4"===o.glsltype||"ivec2"===o.glsltype||"ivec3"===o.glsltype||"ivec4"===o.glsltype||"bvec2"===o.glsltype||"bvec3"===o.glsltype||"bvec4"===o.glsltype))return t.toInstanceArray(o.instance,o.size);if("number"==typeof t&&("int"===o.glsltype||"float"===o.glsltype||"bool"===o.glsltype))return new o.instance([t])}throw console.log(t),"not toArraydata"};if(o.is_array){if(Array.isArray(i))for(let t=0;t<i.length;t++)-1!==o.location[t]&&null!==i[t]&&(i[t]=a(i[t]))}else i=a(i);if("attribute"===o.modifiers){if("number"!=typeof o.location[0])throw"error location is not number";n.bindBuffer(n.ARRAY_BUFFER,i),this.enable_vertex_number[o.location[0]]||(n.enableVertexAttribArray(o.location[0]),this.enable_vertex_number[o.location[0]]=!0),n.vertexAttribPointer(o.location[0],o.size,"FLOAT"===o.btype?n.FLOAT:n.SHORT,!1,0,0)}else if(o.is_array){if(!Array.isArray(i))throw"error data is not Array";for(let t=0;t<i.length;t++)-1!==o.location[t]&&null!==i[t]&&o.bind(o.location[t],i[t])}else o.bind(o.location[0],i);return!0}bindMesh(t){if(!this.isLinked())return 0;const e=this.sys.getGL();if(null===e)return 0;const s=t.getGLData();if(null===s)return 0;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s.ibo.data);const i=s.ibo.array_length;for(const t in this.variable)"uniform"!==this.variable[t].modifiers&&void 0!==s.vbo[t]&&this.bindData(t,s.vbo[t].data);return i}}class x extends n{constructor(){super()}clone(){return super.clone(x)}getGLHash(){return""+this.mode+this.power+this.range+this.position.toString(3)+this.direction.toString(3)+this.color.toString(3)}getGLData(){const t=this.color.mul(this.power);let e=new s(0,0,0);return this.mode===n.MODE.DIRECTIONAL_LIGHT?e=this.direction:this.mode===n.MODE.POINT_LIGHT&&(e=this.position),{lightsData1:new g([this.mode,this.range,e.x,e.y],4,g.datatype.Float32Array),lightsData2:new g([e.z,t.x,t.y,t.z],4,g.datatype.Float32Array)}}}class E extends o{constructor(t,e){super(t,e),this._s3gl=t}getGLHash(){return this.name}getGLData(){const t=this.textureColor,e=this.textureNormal;let s=t.getGLData(),i=e.getGLData();const n=[null===s?0:1,null===i?0:1];return s=null===s?this._s3gl._getDummyTexture():s,i=null===i?this._s3gl._getDummyTexture():i,{materialsColorAndDiffuse:new g([this.color.x,this.color.y,this.color.z,this.diffuse],4,g.datatype.Float32Array),materialsSpecularAndPower:new g([this.specular.x,this.specular.y,this.specular.z,this.power],4,g.datatype.Float32Array),materialsEmission:new g(this.emission,3,g.datatype.Float32Array),materialsAmbientAndReflect:new g([this.ambient.x,this.ambient.y,this.ambient.z,this.reflect],4,g.datatype.Float32Array),materialsTextureExist:new g(n,2,g.datatype.Float32Array),materialsTextureColor:s,materialsTextureNormal:i}}}class w extends c{constructor(){super()}getUniforms(){let t={};const e=this.getMesh().getMaterialArray(),s=Math.min(e.length,4);for(let i=0;i<s;i++){const s=e[i].getGLData();for(const e in s)t[e]||(t[e]=[]),t[e].push(s[e])}const i={};return i.uniforms=t,i}}class T extends u{constructor(){super()}getUniforms(){const t={};t.eyeWorldDirection=this.getCamera().getDirection();{const e=4,s=this.getLights(),i=Math.min(s.length,e);t.lightsLength=new g(i,1,g.datatype.Int32Array);for(let e=0;e<i;e++){const i=s[e].getGLData();for(const e in i)t[e]||(t[e]=[]),t[e].push(i[e])}}const e={};return e.uniforms=t,e}}class v extends a{constructor(t){super(t)}clone(){return super.clone(v)}getGLHash(){return this.position.toString(3)}getGLData(){return{vertexPosition:new g(this.position,3,g.datatype.Float32Array)}}}class M{constructor(t){this.index=t.index,this.materialIndex=t.materialIndex,this.uv=t.uv,this._isEnabledTexture=null!==t.uv[0],this.face={normal:null,tangent:null,binormal:null},this.vertex={normal:[null,null,null],tangent:[null,null,null],binormal:[null,null,null]}}getGLHash(t,e){const s=this._isEnabledTexture?this.uv[t].toString(2)+this.face.binormal.toString(2)+this.face.tangent.toString(2):"";return e[this.index[t]].getGLHash()+this.materialIndex+s+this.vertex.normal[t].toString(3)}getGLData(t,e){const i={},n=e[this.index[t]].getGLData();for(const t in n)i[t]=n[t];const r=this._isEnabledTexture?this.uv[t]:new s(0,0);return i.vertexTextureCoord=new g(r,2,g.datatype.Float32Array),i.vertexMaterialFloat=new g(this.materialIndex,1,g.datatype.Float32Array),i.vertexNormal=new g(this.vertex.normal[t],3,g.datatype.Float32Array),i.vertexBinormal=new g(this.vertex.binormal[t],3,g.datatype.Float32Array),i.vertexTangent=new g(this.vertex.tangent[t],3,g.datatype.Float32Array),i}}class D extends h{constructor(t,e,s,i,n,r){super(t,e,s,i,n,r)}clone(){return super.clone(D)}inverseTriangle(){return super.inverseTriangle(D)}createGLTriangleIndexData(){return new M(this)}}const b={name:"JSON",input:function(t,e,i){let n;n="string"==typeof i?JSON.parse(i):i;let r=0;for(const s in n.Indexes){e.addMaterial(t.createMaterial(s));const i=n.Indexes[s];for(let s=0;s<i.length;s++){const n=i[s];for(let s=0;s<n.length-2;s++){const i=s%2==0?t.createTriangleIndex(s,s+1,s+2,n,r):t.createTriangleIndex(s-1,s+1,s+2,n,r);e.addTriangleIndex(i)}}r++}for(let i=0;i<n.Vertices.length;i++){const r=new s(n.Vertices[i][0],n.Vertices[i][1],n.Vertices[i][2]),o=t.createVertex(r);e.addVertex(o)}return!0},output:function(t){const e=t.getVertexArray(),i=t.getTriangleIndexArray(),n=t.getMaterialArray(),r={name:"s3default",color:new s(1,1,1,1),diffuse:.8,emission:new s(0,0,0),specular:new s(0,0,0),power:5,ambient:new s(.6,.6,.6),reflect:0,textureColor:null,textureNormal:null},o=[],a=0!==n.length?n.length:1,h=r;for(let t=0;t<a;t++)o[t]={material:n[t]?n[t]:h,list:[]};for(let t=0;t<i.length;t++){const e=i[t];o[e.materialIndex].list.push(e.index)}const m=[];m.push("{"),m.push("\tIndexes:{");for(let t=0;t<o.length;t++){const e=o[t];m.push("\t\t"+e.material.name+":[");for(let t=0;t<e.list.length;t++){const s=e.list[t];m.push("\t\t\t["+s[0]+" "+s[1]+" "+s[2]+"]"+(t===e.list.length-1?"":","))}m.push("\t\t]"+(t===o.length-1?"":","))}m.push("\t},"),m.push("\tVertices:[");for(let t=0;t<e.length;t++){const s=e[t].position;m.push("\t\t["+s.x+" "+s.y+" "+s.z+"]"+(t===e.length-1?"":","))}return m.push("\t]"),m.push("}"),m.join("\n")}};class I{constructor(t){this.pathname=t.replace(/\\/g,"/")}getAbsolutePath(){if(/$http/.test(this.pathname))return this.pathname;let t=window.location.toString();/\/$/.test(t)||(t=t.match(/.*\//)[0]);const e=this.pathname.split("/");for(let s=0;s<e.length;s++)""!==e[s]&&"."!==e[s]&&(".."!==e[s]?(t+=e[s],s!==e.length-1&&(t+="/")):t=t.substring(0,t.length-1).match(/.*\//)[0]);return t}getParent(){const t=this.getAbsolutePath().match(/.*\//)[0];return t.substring(0,t.length-1)}}const A=[b,{name:"MQO",input:function(t,e,i,n){let r=null,o="./";n&&(r=new I(n),o=r.getParent()+"/");const a=i.split("\n"),h=[];let m="none";const l=function(t){const e=t.split(" "),s=[];for(let t=0;t<e.length;t++)s[t]=parseFloat(e[t]);return s},c=function(t,e){const s=t.split(" "+e+"(");return 1===s.length?null:s[1].split(")")[0]},u=function(t,e){const s=c(t,e);return null===s?[]:l(s)},d=function(t,e){const s=c(t,e);if(null===s)return null;const i=s.split('"');return 3!==i.length?null:i[1]};for(let i=0;i<a.length;i++){const n=a[i].replace(/^\s+|\s+$/g,""),r=n.split(" ")[0];if(-1===n.indexOf("{"))if(-1===n.indexOf("}")){if("Thumbnail"!==m&&"none"!==m)if("Material"===m){const i=r.replace(/"/g,""),a=t.createMaterial();let h;a.setName(i),h=u(n,"col"),0!==h.length&&a.setColor(new s(h[0],h[1],h[2],h[3])),h=u(n,"dif"),0!==h.length&&a.setDiffuse(h[0]),h=u(n,"amb"),0!==h.length&&a.setAmbient(new s(h[0],h[0],h[0])),h=u(n,"amb_col"),0!==h.length&&a.setAmbient(new s(h[0],h[1],h[2])),h=u(n,"emi"),0!==h.length&&a.setEmission(new s(h[0],h[0],h[0])),h=u(n,"emi_col"),0!==h.length&&a.setEmission(new s(h[0],h[1],h[2])),h=u(n,"spc"),0!==h.length&&a.setSpecular(new s(h[0],h[0],h[0])),h=u(n,"spc_col"),0!==h.length&&a.setSpecular(new s(h[0],h[1],h[2])),h=u(n,"power"),0!==h.length&&a.setPower(h[0]),h=u(n,"reflect"),0!==h.length&&a.setReflect(h[0]),h=d(n,"tex"),h&&a.setTextureColor(o+h),h=d(n,"bump"),h&&a.setTextureNormal(o+h),e.addMaterial(a)}else if("vertex"===m){const i=l(n),r=new s(i[0],i[1],i[2]),o=t.createVertex(r);e.addVertex(o)}else if("face"===m){const i=parseInt(r),o=u(n,"V"),a=u(n,"UV"),h=[],m=u(n,"M"),l=0===m.length?0:m[0];if(0!==a.length)for(let t=0;t<i;t++)h[t]=new s(a[2*t],a[2*t+1],0);for(let s=0;s<i-2;s++){const i=s%2==0?t.createTriangleIndex(s,s+1,s+2,o,l,h):t.createTriangleIndex(s-1,s+1,s+2,o,l,h);e.addTriangleIndex(i)}}}else m=h.pop();else h.push(m),m=r}return!0},output:function(t){const e=[],s=t.getVertexArray(),i=t.getTriangleIndexArray(),n=t.getMaterialArray();e.push("Metasequoia Document"),e.push("Format Text Ver 1.0"),e.push(""),e.push("Scene {"),e.push("\tpos 0 0 1500"),e.push("\tlookat 0 0 0"),e.push("\thead -0.5236"),e.push("\tpich 0.5236"),e.push("\tortho 0"),e.push("\tzoom2 5.0000"),e.push("\tamb 0.250 0.250 0.250"),e.push("}"),e.push("Material "+n.length+" {");for(let t=0;t<n.length;t++){const s=n[t];e.push('\t"'+s.name+'" col(1.000 1.000 1.000 1.000) dif(0.800) amb(0.600) emi(0.000) spc(0.000) power(5.00)')}e.push("}"),e.push('Object "obj1" {'),e.push("\tvertex "+s.length+" {");for(let t=0;t<s.length;t++){const i=s[t].position;e.push("\t\t"+i.x+" "+i.y+" "+i.z)}e.push("}"),e.push("\tface "+i.length+" {");for(let t=0;t<i.length;t++){const s=i[t];let n="\t\t3";n+=" V("+s.index[0]+" "+s.index[1]+" "+s.index[2]+")",n+=" M("+s.materialIndex+")",void 0!==s.uv&&null!==s.uv[0]&&(n+=" UV("+s.uv[0].x+" "+s.uv[0].y+" "+s.uv[1].x+" "+s.uv[1].y+" "+s.uv[2].x+" "+s.uv[2].y+")"),e.push(n)}return e.push("\t}"),e.push("}"),e.push("Eof\n"),e.join("\n")}},{name:"OBJ",input:function(t,e,i){const n=i.split("\n"),r=[],o=[],a=[],h=[];let m=1;for(let t=0;t<n.length;t++){const e=n[t].split("#")[0].trim();if(0===e.length)continue;const i=e.split(" ");if("v"===i[0]){const t=parseFloat(i[1]),e=parseFloat(i[2]),n=parseFloat(i[3]),o=new s(t,e,n);r.push(o)}else if("vt"===i[0]){const t=parseFloat(i[1]),e=parseFloat(i[2]),n=Math.floor(e),r=new s(t,1-(e-n));o.push([r,n]),m<=n+1&&(m=n+1)}else if("vn"===i[0])new s(parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3]));else if("f"===i[0]){const t=i.length-3,e=i[1],s=i[2],n=i[3],r=2===t?i[4]:"0";for(let i=0;i<t;i++){const t=[];i%2==0?(t[2]=e,t[1]=s,t[0]=n):(t[2]=e,t[1]=n,t[0]=r);const o=[],m=[],l=[];for(let e=0;e<3;e++){const s=t[e].split("/");1===s.length?o[e]=parseInt(s[0],10)-1:2===s.length?(o[e]=parseInt(s[0],10)-1,m[e]=parseInt(s[1],10)-1):3===s.length&&(0!==s[1].length?(o[e]=parseInt(s[0],10)-1,m[e]=parseInt(s[1],10)-1,l[e]=parseInt(s[2],10)-1):(o[e]=parseInt(s[0],10)-1,m[e]=null,l[e]=parseInt(s[2],10)-1))}a.push(o),h.push(m)}}}for(let s=0;s<m;s++){const i=t.createMaterial(""+s);e.addMaterial(i)}for(let s=0;s<r.length;s++){const i=t.createVertex(r[s]);e.addVertex(i)}for(let s=0;s<a.length;s++){const i=h[s];let n,r=0;if(i){const t=o[i[0]],e=o[i[1]],s=o[i[2]];r=t[1],n=[t[0],e[0],s[0]]}const m=t.createTriangleIndex(0,1,2,a[s],r,n);e.addTriangleIndex(m)}return!0}}],L={inputData:function(t,e,s,i){const n=t.createMesh();let r=s?s.toUpperCase():"";const o=function(e,s){n._init();for(let o=0;o<A.length;o++)if(A[o].name===r){const r=A[o].input(t,n,e,s);n.setComplete(r),i&&i(n)}},a=function(t){o(t,"string"==typeof e?e:void 0)};if("string"==typeof e&&-1===e.indexOf("\n")&&-1!==e.indexOf(".")){const s=e.split(".").pop();for(let i=0;i<A.length;i++)A[i].name===s.toUpperCase()&&(r=s.toUpperCase(),t._download(e,a))}return o(e,""),n},outputData:function(t,e){for(let s=0;s<A.length;s++)if(A[s].name===e.toUpperCase()&&A[s].output)return A[s].output(t);return null}};
/**
 * IDSwitch.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */
class R{constructor(){this._initIDSwitch()}_initIDSwitch(){this.istyped=!1,this.ispressed=!1,this.isreleased=!1,this.pressed_time=0}clone(){const t=new R;return t.istyped=this.istyped,t.ispressed=this.ispressed,t.isreleased=this.isreleased,t.pressed_time=this.pressed_time,t}keyPressed(){this.ispressed||(this.istyped=!0),this.ispressed=!0,this.pressed_time++}keyReleased(){this.ispressed=!1,this.isreleased=!0,this.pressed_time=0}focusLost(){this.keyReleased()}pickInput(t){if(!(t instanceof R))throw"IllegalArgumentException";t.ispressed=this.ispressed,t.istyped=this.istyped,t.isreleased=this.isreleased,t.pressed_time=this.pressed_time,this.isreleased=!1,this.istyped=!1}}
/**
 * IDPosition.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */class O{x=0;y=0;constructor(t,e){this._initIDPosition(t,e)}_initIDPosition(t,e){if(t instanceof O){const e=t;this.set(e)}else void 0===t?(this.x=0,this.y=0):2===arguments.length?this.set(t,e):(this.x=0,this.y=0)}clone(){return new O(this)}set(t,e){if(t instanceof O){const e=t;this.x=e.x,this.y=e.y}else this.x=t,this.y=e}add(t,e){if(t instanceof O){const e=t;this.x+=e.x,this.y+=e.y}else this.x+=t,this.y+=e}sub(t,e){if(t instanceof O){const e=t;this.x-=e.x,this.y-=e.y}else this.x-=t,this.y-=e}static norm(t,e){const s=t.x-e.x,i=t.y-e.y;return Math.sqrt(s*s+i*i)}}
/**
 * IDDraggableSwitch.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */class C{constructor(t){this._initIDDraggableSwitch(t)}_initIDDraggableSwitch(t){this.mask=t,this.switch=new R,this.client=new O,this.deltaBase=new O,this.dragged=new O}clone(){const t=new C(this.mask);return t.switch=this.switch.clone(),t.client=this.client.clone(),t.deltaBase=this.deltaBase.clone(),t.dragged=this.dragged.clone(),t}correctionForDOM(t){let e=t.target;e||(e=t.currentTarget);let s=0,i=0;if("clientX"in t&&"clientY"in t?(s=t.clientX,i=t.clientY):"touches"in t&&t.touches.length>0&&(s=t.touches[0].clientX,i=t.touches[0].clientY),void 0===e)return new O(s,i);{const t=e;let n=t.clientWidth,r=t.clientHeight;return"width"in e&&"number"==typeof e.width&&(n=e.width),"height"in e&&"number"==typeof e.height&&(r=e.height),new O(s/t.clientWidth*n,i/t.clientHeight*r)}}setPosition(t){const e=this.correctionForDOM(t);this.client.set(e),this.deltaBase.set(e),this.dragged._initIDPosition()}mousePressed(t){const e=this.correctionForDOM(t);t.button===this.mask&&(this.switch.ispressed||this.dragged._initIDPosition(),this.switch.keyPressed(),this.client.set(e),this.deltaBase.set(e))}mouseReleased(t){t.button===this.mask&&this.switch.ispressed&&this.switch.keyReleased()}mouseMoved(t){const e=this.correctionForDOM(t);if(this.switch.ispressed){const t=new O(e);t.sub(this.deltaBase),this.dragged.add(t)}this.client.set(e.x,e.y),this.deltaBase.set(e.x,e.y)}focusLost(){this.switch.focusLost()}pickInput(t){if(!(t instanceof C))throw"IllegalArgumentException";this.switch.pickInput(t.switch),t.client.set(this.client),t.dragged.set(this.dragged),this.dragged._initIDPosition()}}
/**
 * IDMouse.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */class N{constructor(){this._initIDMouse()}_initIDMouse(){this.left=new C(N.MOUSE_EVENTS.BUTTON1_MASK),this.center=new C(N.MOUSE_EVENTS.BUTTON2_MASK),this.right=new C(N.MOUSE_EVENTS.BUTTON3_MASK),this.position=new O,this.wheelrotation=0}clone(){const t=new N;return t.left=this.left.clone(),t.center=this.center.clone(),t.right=this.right.clone(),t.position=this.position.clone(),t.wheelrotation=this.wheelrotation,t}mousePressed(t){this.left.mousePressed(t),this.center.mousePressed(t),this.right.mousePressed(t)}mouseReleased(t){this.left.mouseReleased(t),this.center.mouseReleased(t),this.right.mouseReleased(t)}mouseMoved(t){this.left.mouseMoved(t),this.center.mouseMoved(t),this.right.mouseMoved(t),this.position.x=this.left.client.x,this.position.y=this.left.client.y}mouseWheelMoved(t){0!==t.deltaY&&(this.wheelrotation+=t.deltaY>0?-1:1)}focusLost(){this.left.focusLost(),this.center.focusLost(),this.right.focusLost()}pickInput(t){if(!(t instanceof N))throw"IllegalArgumentException";this.left.pickInput(t.left),this.center.pickInput(t.center),this.right.pickInput(t.right),t.position.set(this.position),t.wheelrotation=this.wheelrotation,this.wheelrotation=0}setListenerOnElement(t){const e=this;t.style.cursor="crosshair",t.style.userSelect="none",t.style.setProperty("-moz-user-select","none"),t.style.setProperty("-webkit-user-select","none"),t.style.setProperty("-ms-user-select","none"),t.style.setProperty("-webkit-touch-callout","none"),t.style.setProperty("-webkit-tap-highlight-color","rgba(0,0,0,0)"),t.addEventListener("mousedown",(function(t){e.mousePressed(t)}),!1),t.addEventListener("mouseup",(function(t){e.mouseReleased(t)}),!1),t.addEventListener("mousemove",(function(t){e.mouseMoved(t)}),!1),t.addEventListener("mouseout",(function(){e.focusLost()}),!1),t.addEventListener("wheel",(function(t){e.mouseWheelMoved(t),t.preventDefault()}),!1),t.addEventListener("contextmenu",(function(t){t.preventDefault()}),!1)}}N.MOUSE_EVENTS={BUTTON1_MASK:0,BUTTON2_MASK:1,BUTTON3_MASK:2};
/**
 * IDTouch.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */
class S extends N{constructor(){super(),this._initIDTouch()}_initIDTouch(){this.touchcount_to_mask={1:N.MOUSE_EVENTS.BUTTON1_MASK,2:N.MOUSE_EVENTS.BUTTON3_MASK,3:N.MOUSE_EVENTS.BUTTON2_MASK};const t=this;this._mousePressed=function(e){t.mousePressed(e)},this._mouseReleased=function(e){t.mouseReleased(e)},this._mouseMoved=function(e){t.mouseMoved(e)},this.isdoubletouch=!1,this._doubleposition_p1=null,this._doubleposition_p2=null}_initPosition(t){this.left.setPosition(t),this.right.setPosition(t),this.center.setPosition(t)}_MultiTouchToMouse(t){let e=0,s=0;for(let i=0;i<t.touches.length;i++)e+=t.touches[i].clientX,s+=t.touches[i].clientY;const i={};if(t.touches.length>0){i.clientX=e/t.touches.length,i.clientY=s/t.touches.length,i.button=this.touchcount_to_mask[t.touches.length];const n=t.touches[0];i.target=n.target?n.target:t.currentTarget}else i.clientX=0,i.clientY=0,i.button=0;return i.touchcount=t.touches.length,i}_MoveMultiTouch(t){if(2===t.touches.length){const e=t.touches[0],s=t.touches[1];if(!1===this.isdoubletouch)this.isdoubletouch=!0,this._doubleposition_p1=new O(e.clientX,e.clientY),this._doubleposition_p2=new O(s.clientX,s.clientY);else{const t=new O(e.clientX,e.clientY),i=new O(s.clientX,s.clientY),n=O.norm(this._doubleposition_p1,this._doubleposition_p2)-O.norm(t,i);this._doubleposition_p1=t,this._doubleposition_p2=i;const r=Math.abs(n)<10?.01*Math.abs(n):.5;this.wheelrotation+=(n>0?-1:1)*r}}else this.isdoubletouch}_actFuncMask(t,e,s,i){const n=t;for(const t in N.MOUSE_EVENTS)n.button=N.MOUSE_EVENTS[t],N.MOUSE_EVENTS[t]===i?e(n):s(n)}_touchStart(t){const e=this._MultiTouchToMouse(t);this._initPosition(e),this._actFuncMask(e,this._mousePressed,this._mouseReleased,e.button)}_touchEnd(t){const e=this._MultiTouchToMouse(t);this._actFuncMask(e,this._mouseReleased,this._mouseReleased,e.button)}_touchMove(t){this._MoveMultiTouch(t);const e=this._MultiTouchToMouse(t);this._actFuncMask(e,this._mouseMoved,this._mouseMoved,e.button)}setListenerOnElement(t){super.setListenerOnElement(t);const e=this,s=function(t){e._touchEnd(t)};t.addEventListener("touchstart",(function(t){e._touchStart(t)}),!1),t.addEventListener("touchend",s,!1),t.addEventListener("touchmove",(function(t){e._touchMove(t),t.preventDefault()}),!1),t.addEventListener("touchcancel",s,!1)}}
/**
 * IDTools.js
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */const F=function(){window.addEventListener("load",(function(){document.body.style.height="100%",document.body.style.overflow="hidden",document.documentElement.style.height="100%",document.documentElement.style.overflow="hidden"}),!1)};
/**
 * InputDetect
 *
 * @module InputDetect
 * @author natade (https://github.com/natade-jp)
 * @license MIT
 */class P{constructor(){this._data=new S}static create(){return new P}setListenerOnElement(t){this._data.setListenerOnElement(t)}pickInput(){const t=new S;return this._data.pickInput(t),t}static noScroll(){F()}}const V={System:d,GLSystem:class extends d{constructor(){super(),this.program=null,this.gl=null,this.is_set=!1,this.program_list=[],this.program_listId=0;const t=this,e={};this.glfunc={createBufferVBO:function(e){const s=t.getGL();if(null===s)return null;const i=s.createBuffer();return s.bindBuffer(s.ARRAY_BUFFER,i),s.bufferData(s.ARRAY_BUFFER,e,s.STATIC_DRAW),s.bindBuffer(s.ARRAY_BUFFER,null),i},createBufferIBO:function(e){const s=t.getGL();if(null===s)return null;const i=s.createBuffer();return s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i),s.bufferData(s.ELEMENT_ARRAY_BUFFER,e,s.STATIC_DRAW),s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,null),i},deleteBuffer:function(e){const s=t.getGL();null!==s&&s.deleteBuffer(e)},createTexture:function(s,i){if(!(i instanceof ImageData||i instanceof HTMLImageElement||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement))throw"createBufferTexture";const n=t.getGL();if(null===n)return null;let r=null;if(!e[s]){r=n.createTexture(),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,i),n.generateMipmap(n.TEXTURE_2D),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null);const t={};t.texture=r,t.count=0,e[s]=t}return r=e[s].texture,e[s].count++,r},deleteTexture:function(s){const i=t.getGL();null!==i&&e[s]&&(e[s].count--,0===e[s].count&&(i.deleteBuffer(e[s].texture),delete e[s]))},createProgram:function(e,s){const i=t.getGL();if(null===i)return null;let n=i.createProgram(),r=!1;return i.attachShader(n,e),i.attachShader(n,s),i.linkProgram(n),i.getProgramParameter(n,i.LINK_STATUS)||(console.log("link error "+i.getProgramInfoLog(n)),i.detachShader(n,e),i.detachShader(n,s),i.deleteProgram(n),n=null,r=!0),{program:n,is_error:r}},deleteProgram:function(e,s,i){const n=t.getGL();if(null===n)return null;n.detachShader(e,s),n.detachShader(e,i),n.deleteProgram(e)},createShader:function(e,s){const i=t.getGL();if(null===i)return null;let n=i.createShader(e),r=!1;return i.shaderSource(n,s),i.compileShader(n),i.getShaderParameter(n,i.COMPILE_STATUS)||(console.log("compile error "+i.getShaderInfoLog(n)),i.deleteShader(n),n=null,r=!0),{shader:n,is_error:r}},deleteShader:function(e){const s=t.getGL();if(null===s)return null;s.deleteShader(e)}}}getGL(){return this.gl}isSetGL(){return null!==this.gl}setCanvas(t){const e=t.getContext("webgl")||t.getContext("experimental-webgl");this.canvas=t,this.gl=e}createProgram(){const t=new _(this,this.program_listId);return this.program_list[this.program_listId]=t,this.program_listId++,t}disposeProgram(){for(const t in this.program_list)this.program_list[t].dispose(),delete this.program_list[t]}setProgram(t){if(null===t)return!1;if(!(t instanceof _))throw"not S3GLProgram";null===this.program&&(this.program=t);return null!==t.getProgram()&&(!(this.program!==t||!this.is_set)||(null!==this.program&&this.program.disuseProgram(),this.program=t,this.program.useProgram(),void(this.is_set=!0)))}clear(){if(null===this.gl)return!1;const t=this.getBackgroundColor();return this.gl.clearColor(t.x,t.y,t.z,t.w),this.gl.clearDepth(1),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),!0}drawElements(t){this.is_set&&(this.gl.drawElements(this.gl.TRIANGLES,t,this.gl.UNSIGNED_SHORT,0),this.gl.flush())}deleteBuffer(t){if(null===this.gl)return null;this.gl.deleteBuffer(t)}_getDummyTexture(){if(void 0===this._textureDummyData){const t=document.createElement("canvas");t.width=1,t.height=1;const e=t.getContext("2d").getImageData(0,0,t.width,t.height);this._textureDummyId=this._createID(),this._textureDummyData=this.glfunc.createTexture(this._textureDummyId,e)}return this._textureDummyData}_setDepthMode(){if(null===this.gl)return null;const t=this.gl;t.enable(t.DEPTH_TEST),t.depthFunc(t.LEQUAL)}_setCullMode(){if(null===this.gl)return null;const t=this.gl;this.cullmode!==d.CULL_MODE.NONE?(t.enable(t.CULL_FACE),this.frontface===d.FRONT_FACE.CLOCKWISE?t.frontFace(t.CW):t.frontFace(t.CCW),this.cullmode===d.CULL_MODE.FRONT_AND_BACK?t.cullFace(t.FRONT_AND_BACK):this.cullmode===d.CULL_MODE.BACK?t.cullFace(t.BACK):this.cullmode===d.CULL_MODE.FRONT&&t.cullFace(t.FRONT)):t.disable(t.CULL_FACE)}_bindStart(){this.program.resetActiveTextureId()}_bindEnd(){}_bind(t,e){if(!this.is_set)return;const s=this.program;let i=0;if(2===arguments.length&&("string"==typeof t||t instanceof String))s.bindData(t,e);else if(1===arguments.length&&t instanceof w){const e=t.getMesh();e instanceof y&&(i=s.bindMesh(e))}else if(1===arguments.length&&t.uniforms){const e=t.uniforms;for(const t in e)s.bindData(t,e[t])}return i}drawScene(t){if(this.setProgram(this.program),!this.is_set)return;this._setDepthMode(),this._setCullMode(),this._bindStart(),this._bind(t.getUniforms());const e=t.getCamera().getVPSMatrix(this.canvas),s=t.getModels();for(let t=0;t<s.length;t++){const i=s[t];if(!1===i.getMesh().isComplete())continue;this._bind(i.getUniforms());const n=this.getMatrixWorldTransform(i),r=this.mulMatrix(n,e.LookAt),o=this.mulMatrix(r,e.PerspectiveFov);this._bind("matrixWorldToLocal4",n.inverse4()),this._bind("matrixLocalToWorld4",n),this._bind("matrixLocalToWorld3",n),this._bind("matrixLocalToPerspective4",o);const a=this._bind(i);a&&this.drawElements(a)}this._bindEnd()}_disposeObject(t){t instanceof p&&this.glfunc.deleteTexture(this.url)}createVertex(t){return new v(t)}createTriangleIndex(t,e,s,i,n,r){return new D(t,e,s,i,n,r)}createTexture(t){return new p(this,t)}createScene(){return new T}createModel(){return new w}createMesh(){return new y(this)}createMaterial(t){return new E(this,t)}createLight(){return new x}createCamera(){return new i(this)}},Math:t,Angles:l,Vector:s,Matrix:e,Plane:class{constructor(t,e){e instanceof s?(this.n=t,this.d=this.n.dot(e)):(this.n=t,this.d=e)}getDistance(t){return t.dot(this.n)-this.d}getNearestPoint(t){return this.n.mul(-this.getDistance(t)).add(t)}isHitPosition(t){return this.getDistance(t)<0}toString(){return"Plane("+this.n.toString()+", ["+this.d+"])"}},SYSTEM_MODE:d.SYSTEM_MODE,DEPTH_MODE:d.DEPTH_MODE,DIMENSION_MODE:d.DIMENSION_MODE,VECTOR_MODE:d.VECTOR_MODE,FRONT_FACE:d.FRONT_FACE,CULL_MODE:d.CULL_MODE,LIGHT_MODE:n.MODE,MeshLoader:L,CameraController:class{constructor(){this.mouse=P.create(),this.moveDistance=4,this.moveRotate=.5,this.moveTranslateRelative=.1}setCanvas(t){this.mouse.setListenerOnElement(t)}setCamera(t){this.camera=t.clone()}getCamera(){const t=this.mouse.pickInput();this.camera.translateRelative(new s(-t.left.dragged.x*this.moveTranslateRelative,t.left.dragged.y*this.moveTranslateRelative,0)),this.camera.addRotateY(t.right.dragged.x*this.moveRotate),this.camera.addRotateX(-t.right.dragged.y*this.moveRotate);let e=this.camera.getDistance();return e-=t.wheelrotation*this.moveDistance*Math.log(e),this.camera.setDistance(e),this.camera}}};module.exports=V;
